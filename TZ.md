# Техническое задание: Система Q&A по документам СРО НОСО

## 1. Общее описание проекта

### 1.1 Название проекта
Система вопросов и ответов (Q&A) по документам Национального объединения строителей (СРО НОСО).

### 1.2 Цель проекта
Создание интеллектуальной системы поиска и генерации ответов на вопросы пользователей по нормативным документам СРО НОСО с использованием технологий Retrieval-Augmented Generation (RAG). Система должна обеспечивать быструю и точную информационную поддержку для специалистов строительной отрасли, повышая эффективность работы с нормативными документами и снижая время на поиск релевантной информации.

### 1.3 Проблематика
Текущие документы СРО НОСО представляют собой обширный массив информации (более 30 документов различных типов), что затрудняет оперативный поиск ответов на конкретные вопросы. Традиционные методы поиска (по ключевым словам) часто неэффективны для сложных запросов, требующих понимания контекста.

### 1.4 Целевые пользователи
- Специалисты строительной отрасли (инженеры, техники,	project менеджеры)
- Руководители СРО НОСО
- Юридические консультанты
- Представители контролирующих органов

### 1.5 Основные функции системы
- **Векторный поиск по документам:** Семантический поиск с учетом контекста и релевантности
- **Генерация ответов на основе релевантного контекста:** AI-генерированные ответы на естественном языке на основе документов
- **Веб-интерфейс для взаимодействия с пользователями:** Удобный графический интерфейс с чатом и просмотром документов
- **Администрирование и просмотр документов:** Инструменты для управления базой документов и проверки целостности данных
- **Историческая поддержка:** Сохранение истории запросов для улучшения системы

## 2. Архитектура системы

### 2.1 Общая архитектура
Система построена по принципу типичной RAG-архитектуры и разделена на следующие слои:
- **Уровень данных:** Хранение оригинальных документов и векторной базы
- **Уровень обработки:** Чанкирование, эмбеддинги, метаданные
- **Уровень поиска:** Векторный поиск и ранжирование
- **Уровень генерации:** AI-ответы на основе контекста
- **Уровень пользовательского интерфейса:** Веб-интерфейс для взаимодействия

### 2.2 Компоненты системы:
- **Векторная база данных:** ChromaDB для хранения эмбеддингов документов и метаданных
- **Модель эмбеддингов:** intfloat/multilingual-e5-base для генерации многомерных векторов текста
- **LLM для генерации ответов:** DeepSeek (deepseek-chat) через API для генерации естественных ответов
- **Локальная LLM для метаданных:** qwen2.5:3b в Ollama для анализа и аннотации чанков
- **Веб-фреймворк:** Gradio для создания пользовательского интерфейса с чатом и элементами управления
- **Бэкенд:** FastAPI + Uvicorn (опционально для API) для потенциального расширения в REST API

### 2.3 Основные модули:
- `rag_app.py` - Основное приложение с Gradio интерфейсом, объединяющее все модули
- `embed_store.py` - Модуль для создания векторных представлений документов и управления коллекциями в ChromaDB
- `retrieval.py` - Модуль для выполнения семантического поиска по эмбеддингам и возврата релевантных чанков
- `chunking.py` - Модуль для интеллектуального разбиения документов на семантически связные фрагменты
- `add_metadata.py` - Модуль для генерация структурированных метаданных для каждого чанка с помощью LLM
- `check_integrity.py` - Модуль для валидации структуры баз данных и документов

### 2.4 Поток данных
1. Оригинальные документы → Текстовый формат
2. Текст → Чанкирование → Эмбеддинги + Метаданные
3. Эмбеддинги → Хранение в векторной БД
4. Запрос пользователя → Поиск → Генерация ответа

## 3. Данные и документы

### 3.1 Источники данных:
Документы СРО НОСО в различных форматах:
- DOCX файлы (оригинальные документы)
- PDF версии (для просмотра)
- TXT версии (используемые для чанкирования)

### 3.2 Типы документов:
- Регламенты ведения НРС НОСТРОЙ/НОПРИЗ
- Профессиональные стандарты специалистов
- Квалификационные стандарты руководителей и специалистов
- Политики (членство, дисциплинарное воздействие, жалобы и т.д.)
- Правила обучения и аттестации
- Этический кодекс строителя
- Стандарты НОСО

### 3.3 Структура чанков:
- Документ → Разделы → Семантические блоки
- Иерархическое чанкирование с учетом заголовков
- Метаданные: ключевые темы, сущности, суммаризация, потенциальные вопросы

## 4. Функциональные требования

### 4.1 Пользовательский интерфейс

#### 4.1.1 Основной чат с AI
- **Ввод вопросов:** Текстовое поле для ввода вопроса на естественном языке
- **Генерация ответов:** Отображение ответа от LLM с выделенными цитатами из документов
- **История диалогов:** История предыдущих вопросов и ответов в сессии

#### 4.1.2 Поиск по документам
- **Интерфейс поиска:** Отдельная вкладка для поиска с текстовым полем запроса
- **Результаты поиска:** Список найденных чанков с релевантностью, метаданными и превью текста
- **Фильтр по документу:** Возможность ограничить поиск определенными документами
- **Иерархическое отображение:** Чанки показаны в структуре документа (разделы, подразделы)

#### 4.1.3 Просмотр документов
- **Список документов:** Выпадающий список или дерево документов с метаинформацией (дата, размер, тип)
- **Детальный просмотр:** Полный текст документа с выделенными чанками
- **Навигация по чанкам:** Переход между чанками с их метаданными (резюме, ключевые слова, вопросы)

### 4.2 Поиск и генерация

#### 4.2.1 Алгоритм поиска
- **Векторный поиск:** Использование косинусного сходства для поиска топ-5 релевантных чанков
- **Гибридный поиск:** Комбинация семантического и ключевого поиска для точности
- **Ранжирование:** Учет релевантности чанков с помощью скоринга

#### 4.2.2 Генерация ответов
- **Контекст из документов:** Передача максимально релевантного контекста в LLM
- **Цитирование источников:** Автоматическое указание страниц/разделов документов в ответе
- **Достоверность:** Обеспечение фактичности ответов на основе документов
- **Язык ответа:** Ответы на русском языке, техническом (но понятном) стиле

#### 4.2.3 Обработка ошибок
- **Fallback-сообщения:** Если поиск не дал результатов, предложение альтернативных запросов
- **Валидация запросов:** Проверка на длину, содержание, предотвращение вредоносных вопросов
- **Логирование:** Запись неудачных запросов для анализа

### 4.3 Администрирование

#### 4.3.1 Управление документами
- **Список документов:** Полный инвентарь с метаданными и статусом обработки
- **Просмотр чанков:** Детальный интерфейс для каждого документа с его чанками и эмбеддингами
- **Мониторинг:** Отслеживание дат последнего обновления и размера базы данных

#### 4.3.2 Аналитика и отчеты
- **Метрики поиска:** Статистика по использованию, популярным запросам
- **Логи ошибок:** Просмотр логов неудачных генераций и поисков
- **Производительность:** Мониторинг скорости ответа и нагрузки на систему

#### 4.3.3 Инструменты поддержки
- **Редактирование метаданных:** Возможность корректировки метаданных чанков через интерфейс администратора. Включает редактирование резюме, ключевых слов, категории и гипотетических вопросов для каждого чанка. Изменения сохраняются в векторной базе и влияют на последующие поиски и генерацию ответов.
- **Переиндексация:** Ресинхронизация базы данных при изменениях документов. Процесс: очистка старых данных по выбранным документам, повторное чанкирование, генерирование эмбеддингов и сохранение новой версии.
- **Экспорт данных:** Выгрузка состояния базы для бэкапа или анализа. Форматы: JSON для метаданных, бинарные файлы для эмбеддингов, текстовые отчеты для статистики.

## 5. Технические требования

### 5.1 Зависимости:
- sentence-transformers (эмбеддинги)
- chromadb (векторная БД)
- langchain (опционально)
- openai (клиент для DeepSeek)
- gradio (веб-интерфейс)
- fastapi/uvicorn (API сервер)
- python-dotenv (конфигурация)
- И другие утилиты для обработки документов

### 5.2 Конфигурация:
- API ключи DeepSeek
- Пути к базам данных
- Параметры поиска (пороги, топ-k)
- Настройки эмбеддингов

### 5.3 Производительность:
- **Максимум 1000 токенов на ответ:** Ограничение длины ответа для предотвращения чрезмерных затрат API
- **Температура 0.3 для детерминированных ответов:** Низкая температура для consistency в ответах
- **Батчевая обработка эмбеддингов (размер 100):** Оптимизация для эффективной обработки большего числа чанков

### 5.4 Нефункциональные требования

#### 5.4.1 Время отклика
- **Поиск чанков:** Не более 5 секунд на запрос
- **Генерация ответа:** Не более 30 секунд на полный ответ
- **Загрузка интерфейса:** Не более 10 секунд при старте

#### 5.4.2 Масштабируемость
- **Число документов:** Поддержка до 100 документов,
- **Размер базы:** До 500 000 чанков в системе
- **Одновременные пользователи:** До 50 одновременно активных пользовательских сессий

#### 5.4.3 Удобство использования
- **Критерии ISO 9241-210:** Интуитивный интерфейс, минимальное обучение
- **Многоязычность:** Вес поддержка русского языка
- **Доступность:** Поддержка экранных читателей и клавиатурной навигации

#### 5.4.4 Надежность
- **Время безотказной работы:** 99% uptime для системы
- **Восстановление:** Автоматическое восстановление после сбоев не более 1 часа
- **Бэкапы:** Ежедневное резервное копирование данных

### 5.5 Совместимость
- **ОС:** Windows 10+, Linux Ubuntu 18+, macOS 10.14+
- **Браузеры:** Chrome 90+, Firefox 85+, Safari 14+
- **Python:** Версия 3.8-3.11
- **Зависимости:** Совместимость с указанными версиями библиотек

## 6. Процесс обработки данных

### 6.1 Подготовка документов:
1. Конвертация DOCX → TXT/MD
2. Чанкирование по иерархии и семантике
3. Создание эмбеддингов
4. Сохранение в ChromaDB

### 6.2. Генерация метаданных с помощью локальной LLM qwen2.5:3b в Ollama:
Для каждого чанка используется следующая схема:
Краткое резюме: 1-2 предложения о содержимом
Ключевые слова: 5-10 слов для поиска
Категория: Тип контента (технический, финансовый и т.д.)
Гипотетические вопросы: 2-3 вопроса, на которые отвечает чанк

### 6.3 Эксперименты:
- Различные стратегии чанкирования
- Оценка качества разбиения
- Тестирование поиска

## 7. Безопасность и конфиденциальность

### 7.1 Управление секретами
- **API ключи:** Безопасное хранение в файле .env с исключением из версионирования
- **Шифрование:** Шифрование всех сохраненных данных, если требуется
- **Аутентификация:** (будущая) возможность добавления аутентификации пользователей

### 7.2 Защита данных
- **Логирование:** Запись только технических сведений без чувствительного контента
- **Валидация ввода:** Проверка и фильтрация пользовательских запросов от вредоносного кода
- **Целостность данных:** Регулярные проверки хэшей документов и баз данных

### 7.3 Соответствие требованиям
- **GDPR/RoSK:** Обеспечение минимального сбора персональных данных
- **Локальные данные:** Предпочтение локального хранения над облачными службами

## 8. Тестирование и развертывание

### 8.1 Стратегия тестирования
- **Модульные тесты:** Тестирование отдельных функций (chunking, retrieval, generation)
- **Интеграционные тесты:** Проверка взаимодействия модулей
- **Тесты производительности:** Нагрузочное тестирование с 50 одновременными пользователями
- **Пользовательские тесты:** Валидация интерфейса и функциональности

### 8.2 Тестовые сценарии
- Корректные запросы на точные ответы
- Обработка нерелевантных или некорректных запросов
- Проверка работы с большими документами
- Тестирование поиска и генерации для различных типов документов

### 8.3 Развертывание

#### 8.3.1 Локальное развертывание
- Запуск через Gradio на локальном сервере: `python rag_app.py` для разработки и тестирования

#### 8.3.2 Серверное развертывание
- Развертывание в Hugging Face Spaces
- Развертывание через Docker

#### 8.3.3 Мониторинг и поддержка
- Интеграция с инструментами наблюдения: Использование Prometheus для метрик, Grafana для dashboards, вачингов для системных ресурсов. Отслеживание производительности и использования для оптимизации.

## 9. Риски и миграции

### 9.1 Технические риски
- **Зависимость от API:** Ограничения на запросы к DeepSeek могут привести к задержкам
- **Качество эмбеддингов:** Низкая точность поиска при изменении модели
- **Производительность БД:** Задержки при увеличении числа документов

### 9.2 Операционные риски
- **Обновление документов:** Необходимость переиндексации при изменении документов
- **Поддержка LLM:** Изменения в API могут потребовать обновления интеграции
- **Масштабируемость:** Нужная оптимизация при превышении заданных лимитов

### 9.3 Миграционные стратегии
- **Миграция моделей:** Гладкая замена эмбеддингов или LLM с реиндексацией
- **Расширение базы:** Постепенное добавление документов с инкрементной обработкой
- **Бэкапирование:** Регулярные snapshots для восстановления

## 10. Процесс разработки

### 10.1 Этапы разработки
1. **Анализ и дизайн:** Определение требований, выбор технологий
2. **Прототипирование:** Создание базовой версии с тестовыми документами
3. **Разработка:** Построение полных модулей с интеграцией
4. **Тестирование:** Модульные и интеграционные тесты, пользовательское тестирование
5. **Оптимизация:** Улучшение производительности и точности
6. **Развертывание:** Запуск в продуктовой среде с мониторингом

### 10.2 Метрики успеха
- **Точность поиска:** Минимум 90% релевантности в топ-5 результатах
- **Время ответа:** Среднее время менее 10 секунд
- **Удовлетворенность пользователей:** Оценка выше 8/10 в пользовательском тестировании

### 10.3 Документация
- **Техническая документация:** docs/architecture.md — Детали API, архитектуры, зависимостей
- **Пользовательская документация:** docs/user_guide.md — Руководство по использованию системы
- **Административная документация:** docs/admin_guide.md — Инструкции по развертыванию и поддержке
